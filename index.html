<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Defensoria Pública MS</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Botão de admin no canto superior direito -->
  <button id="adminBtn" class="admin-btn" onclick="toggleLoginModal()">
    🔐 Área Administrativa
  </button>

  <div class="container">

    <!-- Barra de busca centralizada -->
    <div class="search-bar">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Pesquise por unidade, órgão ou defensor..." 
        onkeyup="searchUnit()" 
      />
    </div>

    <!-- Filtros -->
    <div class="filters">
      <label>
        <input type="radio" name="filter" value="todos" checked onchange="searchUnit()"> Todas Defensorias
      </label>
      <label>
        <input type="radio" name="filter" value="vagos" onchange="searchUnit()"> Defensorias Vagas
      </label>
      <label>
        <input type="radio" name="filter" value="afastados" onchange="searchUnit()"> Titulares Afastados
      </label>
      <label class="filter-chip" id="toggleRegionalChip">
        <input type="checkbox" id="toggleRegionalCheckbox" onchange="toggleRegionalFilters()">
        <span id="toggleRegionalText">Filtrar por Regional</span>
        <span id="toggleRegionalIcon">▼</span>
      </label>
      <button class="collapse-all-btn" id="collapseAllBtn" onclick="toggleAllUnits()">
        <span id="collapseAllIcon">📁</span>
        <span id="collapseAllText">Colapsar Todas</span>
      </button>
    </div>

    <!-- Filtros por Regional -->
    <div class="regional-filters">
      <div class="regional-chips" id="regionalChips" style="display: none;">
        <!-- Chips das regionais serão carregados aqui -->
      </div>
    </div>

    <div id="unitList" class="unit-list">
      <!-- Unidades aparecem aqui -->
    </div>
  </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>🔐 Área Administrativa</h2>
          <span class="close" onclick="closeLoginModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="form-group">
              <label for="username">Usuário:</label>
              <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
              <label for="password">Senha:</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div class="form-actions">
              <button type="button" onclick="closeLoginModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-login">Entrar</button>
            </div>
          </form>
          <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Área Administrativa -->
    <div id="adminArea" class="admin-area" style="display: none;">
      <div class="admin-header">
        <h2>🔧 Painel Administrativo</h2>
        <div class="admin-actions">
          <span id="adminWelcome" class="admin-welcome"></span>
          <button onclick="logout()" class="btn-logout">Sair</button>
        </div>
      </div>

      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showAdminTab('dashboard')">📊 Dashboard</button>
        <button class="tab-btn" onclick="showAdminTab('unidades')">🏢 Unidades</button>
        <button class="tab-btn" onclick="showAdminTab('orgaos')">👥 Defensorias</button>
      </div>

      <!-- Dashboard -->
      <div id="adminDashboard" class="admin-tab-content active">
        <div class="dashboard-stats">
          <div class="stat-card">
            <h3>Total de Unidades</h3>
            <span id="totalUnidades" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Total de Defensorias</h3>
            <span id="totalOrgaos" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Defensorias Vagas</h3>
            <span id="orgaosVagos" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Titulares Afastados</h3>
            <span id="titularesAfastados" class="stat-number">-</span>
          </div>
        </div>

              <!-- Gráficos e Análises Detalhadas -->
              <div class="dashboard-charts">
                <!-- Gráficos removidos temporariamente -->
              </div>

        <div class="dashboard-tables">
          <div class="table-container">
            <h3>📊 Estatísticas por Regional</h3>
            <div class="table-wrapper">
              <table id="regionaisTable">
                <thead>
                  <tr>
                    <th onclick="sortTable('regionaisTable', 0)" class="sortable">
                      Regional <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('regionaisTable', 1)" class="sortable">
                      Total Defensorias <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('regionaisTable', 2)" class="sortable">
                      Defensorias Vagas <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('regionaisTable', 3)" class="sortable">
                      % Vagas <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('regionaisTable', 4)" class="sortable">
                      Total Titulares <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('regionaisTable', 5)" class="sortable">
                      Titulares Afastados <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('regionaisTable', 6)" class="sortable">
                      % Afastados <span class="sort-icon">↕️</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="regionaisTableBody">
                  <!-- Dados serão carregados aqui -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="table-container">
            <h3>📋 Listagem das Defensorias Vagas e dos Titulares Afastados</h3>
            <div class="table-wrapper">
              <table id="problemasTable">
                <thead>
                  <tr>
                    <th onclick="sortTable('problemasTable', 0)" class="sortable">
                      Defensoria <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('problemasTable', 1)" class="sortable">
                      Unidade <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('problemasTable', 2)" class="sortable">
                      Regional <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('problemasTable', 3)" class="sortable">
                      Status <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('problemasTable', 4)" class="sortable">
                      Titular <span class="sort-icon">↕️</span>
                    </th>
                    <th onclick="sortTable('problemasTable', 5)" class="sortable">
                      Substituto <span class="sort-icon">↕️</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="problemasTableBody">
                  <!-- Dados serão carregados aqui -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gestão de Unidades -->
      <div id="adminUnidades" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>🏢 Gestão de Unidades</h3>
          <button onclick="openUnidadeModal()" class="btn-add">+ Nova Unidade</button>
        </div>
        <div id="unidadesList" class="admin-list">
          <!-- Lista de unidades será carregada aqui -->
        </div>
      </div>

      <!-- Gestão de Órgãos -->
      <div id="adminOrgaos" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>👥 Gestão de Defensorias</h3>
          <button onclick="openOrgaoModal()" class="btn-add">+ Nova Defensoria</button>
        </div>
        <div id="orgaosList" class="admin-list">
          <!-- Lista de defensorias será carregada aqui -->
        </div>
      </div>

    </div>

    <!-- Modal de Unidade -->
    <div id="unidadeModal" class="modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2 id="unidadeModalTitle">Nova Unidade</h2>
          <span class="close" onclick="closeUnidadeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="unidadeForm">
            <input type="hidden" id="unidadeId">
            <div class="form-row">
              <div class="form-group">
                <label for="unidadeNome">Nome da Unidade *</label>
                <input type="text" id="unidadeNome" required>
              </div>
              <div class="form-group">
                <label for="unidadeRegional">Regional *</label>
                <select id="unidadeRegional" required>
                  <option value="">Selecione uma regional</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="unidadeEndereco">Endereço *</label>
                <input type="text" id="unidadeEndereco" required>
              </div>
              <div class="form-group">
                <label for="unidadeTelefone">Telefone *</label>
                <input type="text" id="unidadeTelefone" required>
              </div>
            </div>
            
            <div class="form-section">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="unidadeTemCoordenador">
                  <span class="checkmark"></span>
                  Esta unidade possui coordenação
                </label>
              </div>
              <div id="coordenadorFields" class="conditional-fields" style="display: none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="unidadeCoordenador">Nome da Coordenação *</label>
                    <input type="text" id="unidadeCoordenador">
                  </div>
                  <div class="form-group">
                    <label for="unidadeEmailCoordenador">Email da Coordenação *</label>
                    <input type="email" id="unidadeEmailCoordenador">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-section">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="unidadeTemSupervisor">
                  <span class="checkmark"></span>
                  Esta unidade possui supervisão
                </label>
              </div>
              <div id="supervisorFields" class="conditional-fields" style="display: none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="unidadeSupervisor">Nome da Supervisão *</label>
                    <input type="text" id="unidadeSupervisor">
                  </div>
                  <div class="form-group">
                    <label for="unidadeEmailSupervisor">Email da Supervisão *</label>
                    <input type="email" id="unidadeEmailSupervisor">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Coordenações de Segunda Instância (apenas para CAMPO GRANDE | 2ª INSTÂNCIA) -->
            <div id="coordenacoesSegundaInstancia" class="form-section" style="display: none;">
              <h4>🎯 Coordenações de Segunda Instância</h4>
              
              <div class="coordenacao-group">
                <h5>Coordenação Administrativa</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoAdminNome">Nome da Coordenação *</label>
                    <input type="text" id="coordenacaoAdminNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoAdminEmail">Email da Coordenação</label>
                    <input type="email" id="coordenacaoAdminEmail">
                  </div>
                </div>
              </div>
              
              <div class="coordenacao-group">
                <h5>Coordenação Cível</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoCivelNome">Nome da Coordenação *</label>
                    <input type="text" id="coordenacaoCivelNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoCivelEmail">Email da Coordenação</label>
                    <input type="email" id="coordenacaoCivelEmail">
                  </div>
                </div>
              </div>
              
              <div class="coordenacao-group">
                <h5>Coordenação Criminal</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoCriminalNome">Nome da Coordenação *</label>
                    <input type="text" id="coordenacaoCriminalNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoCriminalEmail">Email da Coordenação</label>
                    <input type="email" id="coordenacaoCriminalEmail">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" onclick="closeUnidadeModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de Defensoria -->
    <div id="orgaoModal" class="modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2 id="orgaoModalTitle">Nova Defensoria</h2>
          <span class="close" onclick="closeOrgaoModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="orgaoForm">
            <input type="hidden" id="orgaoId">
            <div class="form-row">
              <div class="form-group">
                <label for="orgaoNome">Nome da Defensoria *</label>
                <input type="text" id="orgaoNome" required>
              </div>
              <div class="form-group">
                <label for="orgaoUnidade">Unidade *</label>
                <select id="orgaoUnidade" required>
                  <option value="">Selecione uma unidade</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="orgaoVaga">
                <span class="checkmark"></span>
                Defensoria vaga
              </label>
            </div>
            
            <div id="titularFields" class="conditional-fields">
              <div class="form-section">
                <h4>Titular</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orgaoTitularNome">Nome do Titular *</label>
                    <input type="text" id="orgaoTitularNome">
                  </div>
                  <div class="form-group">
                    <label for="orgaoTitularEmail">Email do Titular *</label>
                    <input type="email" id="orgaoTitularEmail">
                  </div>
                </div>
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="orgaoTitularAfastado">
                    <span class="checkmark"></span>
                    Titular afastado
                  </label>
                </div>
              </div>
            </div>
            
            <div id="substitutoFields" class="conditional-fields" style="display: none;">
              <div class="form-section">
                <h4>Substituto</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orgaoSubstitutoNome">Nome do Substituto *</label>
                    <input type="text" id="orgaoSubstitutoNome">
                  </div>
                  <div class="form-group">
                    <label for="orgaoSubstitutoEmail">Email do Substituto *</label>
                    <input type="email" id="orgaoSubstitutoEmail">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" onclick="closeOrgaoModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>


  <script>
    // Dashboard Charts and Data Loading
    let dashboardData = {};

    // Load dashboard data when admin dashboard is shown
    async function loadDashboardData() {
      console.log('🔄 Carregando dados do dashboard...');
      try {
        // Load statistics
        console.log('📊 Carregando estatísticas...');
        const statsResponse = await fetch('/api/dashboard/stats');
        dashboardData.stats = await statsResponse.json();
        console.log('✅ Estatísticas carregadas:', dashboardData.stats);
        updateStatsDisplay();

        // Load regional data
        console.log('🏢 Carregando dados regionais...');
        const regionaisResponse = await fetch('/api/dashboard/regionais');
        dashboardData.regionais = await regionaisResponse.json();
        console.log('✅ Dados regionais carregados:', dashboardData.regionais.length, 'regionais');
        renderRegionaisTable();

        // Load problems data
        console.log('⚠️ Carregando dados dos problemas...');
        const problemasResponse = await fetch('/api/dashboard/problemas');
        dashboardData.problemas = await problemasResponse.json();
        console.log('✅ Dados dos problemas carregados:', dashboardData.problemas.length, 'problemas');
        renderProblemasTable();

        console.log('🎉 Dashboard carregado com sucesso!');

      } catch (error) {
        console.error('❌ Erro ao carregar dados do dashboard:', error);
        showError('Erro ao carregar dados do dashboard');
      }
    }

    function updateStatsDisplay() {
      if (dashboardData.stats) {
        document.getElementById('totalUnidades').textContent = dashboardData.stats.total_unidades;
        document.getElementById('totalOrgaos').textContent = dashboardData.stats.total_defensorias;
        document.getElementById('orgaosVagos').textContent = dashboardData.stats.defensorias_vagas;
        document.getElementById('titularesAfastados').textContent = dashboardData.stats.titulares_afastados;
      }
    }


    function renderRegionaisTable() {
      if (!dashboardData.regionais) return;

      const tbody = document.getElementById('regionaisTableBody');
      tbody.innerHTML = '';

      dashboardData.regionais.forEach(regional => {
        const row = document.createElement('tr');
        
        // Calcular percentuais
        const totalDefensorias = parseInt(regional.total_defensorias) || 0;
        const defensoriasVagas = parseInt(regional.defensorias_vagas) || 0;
        const titularesAfastados = parseInt(regional.titulares_afastados) || 0;
        
        const percentVagas = totalDefensorias > 0 ? 
          ((defensoriasVagas / totalDefensorias) * 100).toFixed(1) : '0.0';
        const percentAfastados = totalDefensorias > 0 ? 
          ((titularesAfastados / totalDefensorias) * 100).toFixed(1) : '0.0';
        
        // Classes para destacar percentuais altos
        const vagasClass = parseFloat(percentVagas) > 20 ? 'percent-alto' : 
                          parseFloat(percentVagas) > 10 ? 'percent-medio' : 'percent-baixo';
        const afastadosClass = parseFloat(percentAfastados) > 20 ? 'percent-alto' : 
                              parseFloat(percentAfastados) > 10 ? 'percent-medio' : 'percent-baixo';
        
        row.innerHTML = `
          <td>${regional.nome}</td>
          <td>${totalDefensorias}</td>
          <td>${defensoriasVagas}</td>
          <td><span class="percent-problemas ${vagasClass}">${percentVagas}%</span></td>
          <td>${totalDefensorias}</td>
          <td>${titularesAfastados}</td>
          <td><span class="percent-problemas ${afastadosClass}">${percentAfastados}%</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderProblemasTable() {
      if (!dashboardData.problemas) return;

      const tbody = document.getElementById('problemasTableBody');
      tbody.innerHTML = '';


      dashboardData.problemas.forEach(problema => {
        const row = document.createElement('tr');
        const statusClass = problema.status === 'Vaga' ? 'status-vaga' : 
                           problema.status === 'Afastado' ? 'status-afastado' : 'status-ambos';
        
        row.innerHTML = `
          <td>${problema.nome}</td>
          <td>${problema.unidade_nome}</td>
          <td>${problema.regional_nome}</td>
          <td><span class="status-badge ${statusClass}">${problema.status}</span></td>
          <td>${problema.titular_nome || '-'}</td>
          <td>${problema.substituto_nome || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function showError(message) {
      console.error(message);
      // You can add a toast notification here if needed
    }

    // Override the original showAdminTab function to load dashboard data
    const originalShowAdminTab = window.showAdminTab;
    window.showAdminTab = function(tabName) {
      originalShowAdminTab(tabName);
      if (tabName === 'dashboard') {
        // Aguardar um pouco para garantir que o DOM está pronto
        setTimeout(() => {
          loadDashboardData();
        }, 100);
      }
    };

    // Carregar dados do dashboard quando a página carregar (se já estiver na aba dashboard)
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se já estamos na aba dashboard
      const dashboardTab = document.getElementById('adminDashboard');
      if (dashboardTab && dashboardTab.classList.contains('active')) {
        setTimeout(() => {
          loadDashboardData();
        }, 500);
      }
    });

    // Função para ordenar tabelas
    function sortTable(tableId, columnIndex) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headers = table.querySelectorAll('th');
      
      // Determinar direção da ordenação
      const currentHeader = headers[columnIndex];
      const currentSort = currentHeader.getAttribute('data-sort');
      const newSort = currentSort === 'asc' ? 'desc' : 'asc';
      
      // Limpar indicadores de ordenação de todas as colunas
      headers.forEach(header => {
        header.removeAttribute('data-sort');
        const icon = header.querySelector('.sort-icon');
        icon.classList.remove('sorted-asc', 'sorted-desc');
      });
      
      // Definir nova ordenação
      currentHeader.setAttribute('data-sort', newSort);
      const icon = currentHeader.querySelector('.sort-icon');
      icon.classList.add(newSort === 'asc' ? 'sorted-asc' : 'sorted-desc');
      
      // Ordenar linhas
      rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // Verificar se é numérico (incluindo percentuais)
        const aNum = parseFloat(aValue.replace('%', ''));
        const bNum = parseFloat(bValue.replace('%', ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          // Ordenação numérica
          return newSort === 'asc' ? aNum - bNum : bNum - aNum;
        } else {
          // Ordenação alfabética
          return newSort === 'asc' 
            ? aValue.localeCompare(bValue, 'pt-BR', { numeric: true })
            : bValue.localeCompare(aValue, 'pt-BR', { numeric: true });
        }
      });
      
      // Reordenar linhas na tabela
      rows.forEach(row => tbody.appendChild(row));
    }
  </script>
  <script src="script.js"></script>
</body>
</html>
