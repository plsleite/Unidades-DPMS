<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Defensoria P√∫blica MS</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Bot√£o de admin no canto superior direito -->
  <button id="adminBtn" class="admin-btn" onclick="toggleLoginModal()">
    üîê √Årea Administrativa
  </button>

  <div class="container">

    <!-- Barra de busca centralizada -->
    <div class="search-bar">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Pesquise por unidade, √≥rg√£o ou defensor..." 
        onkeyup="searchUnit()" 
      />
    </div>

    <!-- Filtros -->
    <div class="filters">
      <label>
        <input type="radio" name="filter" value="todos" checked onchange="searchUnit()"> Todas Defensorias
      </label>
      <label>
        <input type="radio" name="filter" value="vagos" onchange="searchUnit()"> Defensorias Vagas
      </label>
      <label>
        <input type="radio" name="filter" value="afastados" onchange="searchUnit()"> Titulares Afastados
      </label>
      <label class="filter-chip" id="toggleRegionalChip">
        <input type="checkbox" id="toggleRegionalCheckbox" onchange="toggleRegionalFilters()">
        <span id="toggleRegionalText">Filtrar por Regional</span>
        <span id="toggleRegionalIcon">‚ñº</span>
      </label>
      <button class="collapse-all-btn" id="collapseAllBtn" onclick="toggleAllUnits()">
        <span id="collapseAllIcon">üìÅ</span>
        <span id="collapseAllText">Colapsar Todas</span>
      </button>
    </div>

    <!-- Filtros por Regional -->
    <div class="regional-filters">
      <div class="regional-chips" id="regionalChips" style="display: none;">
        <!-- Chips das regionais ser√£o carregados aqui -->
      </div>
    </div>

    <div id="unitList" class="unit-list">
      <!-- Unidades aparecem aqui -->
    </div>
  </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üîê √Årea Administrativa</h2>
          <span class="close" onclick="closeLoginModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="form-group">
              <label for="username">Usu√°rio:</label>
              <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
              <label for="password">Senha:</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div class="form-actions">
              <button type="button" onclick="closeLoginModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-login">Entrar</button>
            </div>
          </form>
          <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- √Årea Administrativa -->
    <div id="adminArea" class="admin-area" style="display: none;">
      <div class="admin-header">
        <h2>üîß Painel Administrativo</h2>
        <div class="admin-actions">
          <span id="adminWelcome" class="admin-welcome"></span>
          <button onclick="logout()" class="btn-logout">Sair</button>
        </div>
      </div>

      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showAdminTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="showAdminTab('unidades')">üè¢ Unidades</button>
        <button class="tab-btn" onclick="showAdminTab('orgaos')">üë• Defensorias</button>
      </div>

      <!-- Dashboard -->
      <div id="adminDashboard" class="admin-tab-content active">
        <div class="dashboard-stats">
          <div class="stat-card">
            <h3>Total de Unidades</h3>
            <span id="totalUnidades" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Total de Defensorias</h3>
            <span id="totalOrgaos" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Defensorias Vagas</h3>
            <span id="orgaosVagos" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Titulares Afastados</h3>
            <span id="titularesAfastados" class="stat-number">-</span>
          </div>
        </div>

              <!-- Gr√°ficos e An√°lises Detalhadas -->
              <div class="dashboard-charts">
                <!-- Gr√°ficos removidos temporariamente -->
              </div>

        <div class="dashboard-tables">
          <div class="table-container">
            <h3>üè¢ Unidades com Mais Problemas</h3>
            <div class="table-wrapper">
              <table id="unidadesTable">
                <thead>
                  <tr>
                    <th>Unidade</th>
                    <th>Regional</th>
                    <th>Total Defensorias</th>
                    <th>Vagas</th>
                    <th>Afastados</th>
                    <th>% Problemas</th>
                  </tr>
                </thead>
                <tbody id="unidadesTableBody">
                  <!-- Dados ser√£o carregados aqui -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="table-container">
            <h3>‚ö†Ô∏è Defensorias com Problemas</h3>
            <div class="table-wrapper">
              <table id="problemasTable">
                <thead>
                  <tr>
                    <th>Defensoria</th>
                    <th>Unidade</th>
                    <th>Regional</th>
                    <th>Status</th>
                    <th>Titular</th>
                    <th>Substituto</th>
                  </tr>
                </thead>
                <tbody id="problemasTableBody">
                  <!-- Dados ser√£o carregados aqui -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gest√£o de Unidades -->
      <div id="adminUnidades" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>üè¢ Gest√£o de Unidades</h3>
          <button onclick="openUnidadeModal()" class="btn-add">+ Nova Unidade</button>
        </div>
        <div id="unidadesList" class="admin-list">
          <!-- Lista de unidades ser√° carregada aqui -->
        </div>
      </div>

      <!-- Gest√£o de √ìrg√£os -->
      <div id="adminOrgaos" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>üë• Gest√£o de Defensorias</h3>
          <button onclick="openOrgaoModal()" class="btn-add">+ Nova Defensoria</button>
        </div>
        <div id="orgaosList" class="admin-list">
          <!-- Lista de defensorias ser√° carregada aqui -->
        </div>
      </div>

    </div>

    <!-- Modal de Unidade -->
    <div id="unidadeModal" class="modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2 id="unidadeModalTitle">Nova Unidade</h2>
          <span class="close" onclick="closeUnidadeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="unidadeForm">
            <input type="hidden" id="unidadeId">
            <div class="form-row">
              <div class="form-group">
                <label for="unidadeNome">Nome da Unidade *</label>
                <input type="text" id="unidadeNome" required>
              </div>
              <div class="form-group">
                <label for="unidadeRegional">Regional *</label>
                <select id="unidadeRegional" required>
                  <option value="">Selecione uma regional</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="unidadeEndereco">Endere√ßo *</label>
                <input type="text" id="unidadeEndereco" required>
              </div>
              <div class="form-group">
                <label for="unidadeTelefone">Telefone *</label>
                <input type="text" id="unidadeTelefone" required>
              </div>
            </div>
            
            <div class="form-section">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="unidadeTemCoordenador">
                  <span class="checkmark"></span>
                  Esta unidade possui coordena√ß√£o
                </label>
              </div>
              <div id="coordenadorFields" class="conditional-fields" style="display: none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="unidadeCoordenador">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="unidadeCoordenador">
                  </div>
                  <div class="form-group">
                    <label for="unidadeEmailCoordenador">Email da Coordena√ß√£o *</label>
                    <input type="email" id="unidadeEmailCoordenador">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-section">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="unidadeTemSupervisor">
                  <span class="checkmark"></span>
                  Esta unidade possui supervis√£o
                </label>
              </div>
              <div id="supervisorFields" class="conditional-fields" style="display: none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="unidadeSupervisor">Nome da Supervis√£o *</label>
                    <input type="text" id="unidadeSupervisor">
                  </div>
                  <div class="form-group">
                    <label for="unidadeEmailSupervisor">Email da Supervis√£o *</label>
                    <input type="email" id="unidadeEmailSupervisor">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Coordena√ß√µes de Segunda Inst√¢ncia (apenas para CAMPO GRANDE | 2¬™ INST√ÇNCIA) -->
            <div id="coordenacoesSegundaInstancia" class="form-section" style="display: none;">
              <h4>üéØ Coordena√ß√µes de Segunda Inst√¢ncia</h4>
              
              <div class="coordenacao-group">
                <h5>Coordena√ß√£o Administrativa</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoAdminNome">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="coordenacaoAdminNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoAdminEmail">Email da Coordena√ß√£o</label>
                    <input type="email" id="coordenacaoAdminEmail">
                  </div>
                </div>
              </div>
              
              <div class="coordenacao-group">
                <h5>Coordena√ß√£o C√≠vel</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoCivelNome">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="coordenacaoCivelNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoCivelEmail">Email da Coordena√ß√£o</label>
                    <input type="email" id="coordenacaoCivelEmail">
                  </div>
                </div>
              </div>
              
              <div class="coordenacao-group">
                <h5>Coordena√ß√£o Criminal</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoCriminalNome">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="coordenacaoCriminalNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoCriminalEmail">Email da Coordena√ß√£o</label>
                    <input type="email" id="coordenacaoCriminalEmail">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" onclick="closeUnidadeModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de Defensoria -->
    <div id="orgaoModal" class="modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2 id="orgaoModalTitle">Nova Defensoria</h2>
          <span class="close" onclick="closeOrgaoModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="orgaoForm">
            <input type="hidden" id="orgaoId">
            <div class="form-row">
              <div class="form-group">
                <label for="orgaoNome">Nome da Defensoria *</label>
                <input type="text" id="orgaoNome" required>
              </div>
              <div class="form-group">
                <label for="orgaoUnidade">Unidade *</label>
                <select id="orgaoUnidade" required>
                  <option value="">Selecione uma unidade</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="orgaoVaga">
                <span class="checkmark"></span>
                Defensoria vaga
              </label>
            </div>
            
            <div id="titularFields" class="conditional-fields">
              <div class="form-section">
                <h4>Titular</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orgaoTitularNome">Nome do Titular *</label>
                    <input type="text" id="orgaoTitularNome">
                  </div>
                  <div class="form-group">
                    <label for="orgaoTitularEmail">Email do Titular *</label>
                    <input type="email" id="orgaoTitularEmail">
                  </div>
                </div>
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="orgaoTitularAfastado">
                    <span class="checkmark"></span>
                    Titular afastado
                  </label>
                </div>
              </div>
            </div>
            
            <div id="substitutoFields" class="conditional-fields" style="display: none;">
              <div class="form-section">
                <h4>Substituto</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orgaoSubstitutoNome">Nome do Substituto *</label>
                    <input type="text" id="orgaoSubstitutoNome">
                  </div>
                  <div class="form-group">
                    <label for="orgaoSubstitutoEmail">Email do Substituto *</label>
                    <input type="email" id="orgaoSubstitutoEmail">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" onclick="closeOrgaoModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>


  <script>
    // Dashboard Charts and Data Loading
    let dashboardData = {};

    // Load dashboard data when admin dashboard is shown
    async function loadDashboardData() {
      console.log('üîÑ Carregando dados do dashboard...');
      try {
        // Load statistics
        console.log('üìä Carregando estat√≠sticas...');
        const statsResponse = await fetch('/api/dashboard/stats');
        dashboardData.stats = await statsResponse.json();
        console.log('‚úÖ Estat√≠sticas carregadas:', dashboardData.stats);
        updateStatsDisplay();

        // Load regional data
        console.log('üè¢ Carregando dados regionais...');
        const regionaisResponse = await fetch('/api/dashboard/regionais');
        dashboardData.regionais = await regionaisResponse.json();
        console.log('‚úÖ Dados regionais carregados:', dashboardData.regionais.length, 'regionais');

        // Load units data
        console.log('üèõÔ∏è Carregando dados das unidades...');
        const unidadesResponse = await fetch('/api/dashboard/unidades');
        dashboardData.unidades = await unidadesResponse.json();
        console.log('‚úÖ Dados das unidades carregados:', dashboardData.unidades.length, 'unidades');
        renderUnidadesTable();

        // Load problems data
        console.log('‚ö†Ô∏è Carregando dados dos problemas...');
        const problemasResponse = await fetch('/api/dashboard/problemas');
        dashboardData.problemas = await problemasResponse.json();
        console.log('‚úÖ Dados dos problemas carregados:', dashboardData.problemas.length, 'problemas');
        renderProblemasTable();

        console.log('üéâ Dashboard carregado com sucesso!');

      } catch (error) {
        console.error('‚ùå Erro ao carregar dados do dashboard:', error);
        showError('Erro ao carregar dados do dashboard');
      }
    }

    function updateStatsDisplay() {
      if (dashboardData.stats) {
        document.getElementById('totalUnidades').textContent = dashboardData.stats.total_unidades;
        document.getElementById('totalOrgaos').textContent = dashboardData.stats.total_defensorias;
        document.getElementById('orgaosVagos').textContent = dashboardData.stats.defensorias_vagas;
        document.getElementById('titularesAfastados').textContent = dashboardData.stats.titulares_afastados;
      }
    }


    function renderUnidadesTable() {
      if (!dashboardData.unidades) return;

      const tbody = document.getElementById('unidadesTableBody');
      tbody.innerHTML = '';

      // Sort by problems percentage
      const sortedUnidades = dashboardData.unidades
        .map(u => ({
          ...u,
          percentProblemas: u.total_defensorias > 0 ? 
            ((parseInt(u.defensorias_vagas) + parseInt(u.titulares_afastados)) / parseInt(u.total_defensorias) * 100).toFixed(1) : 0
        }))
        .sort((a, b) => parseFloat(b.percentProblemas) - parseFloat(a.percentProblemas))
        .slice(0, 10); // Top 10

      sortedUnidades.forEach(unidade => {
        const row = document.createElement('tr');
        const percent = parseFloat(unidade.percentProblemas);
        const percentClass = percent > 30 ? 'percent-alto' : percent > 15 ? 'percent-medio' : 'percent-baixo';
        
        row.innerHTML = `
          <td>${unidade.nome}</td>
          <td>Regional ${unidade.regional_numero}</td>
          <td>${unidade.total_defensorias}</td>
          <td>${unidade.defensorias_vagas}</td>
          <td>${unidade.titulares_afastados}</td>
          <td><span class="percent-problemas ${percentClass}">${unidade.percentProblemas}%</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderProblemasTable() {
      if (!dashboardData.problemas) return;

      const tbody = document.getElementById('problemasTableBody');
      tbody.innerHTML = '';

      dashboardData.problemas.slice(0, 20).forEach(problema => {
        const row = document.createElement('tr');
        const statusClass = problema.status === 'Vaga' ? 'status-vaga' : 
                           problema.status === 'Afastado' ? 'status-afastado' : 'status-ambos';
        
        row.innerHTML = `
          <td>${problema.nome}</td>
          <td>${problema.unidade_nome}</td>
          <td>${problema.regional_nome}</td>
          <td><span class="status-badge ${statusClass}">${problema.status}</span></td>
          <td>${problema.titular_nome || '-'}</td>
          <td>${problema.substituto_nome || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function showError(message) {
      console.error(message);
      // You can add a toast notification here if needed
    }

    // Override the original showAdminTab function to load dashboard data
    const originalShowAdminTab = window.showAdminTab;
    window.showAdminTab = function(tabName) {
      originalShowAdminTab(tabName);
      if (tabName === 'dashboard') {
        // Aguardar um pouco para garantir que o DOM est√° pronto
        setTimeout(() => {
          loadDashboardData();
        }, 100);
      }
    };

    // Carregar dados do dashboard quando a p√°gina carregar (se j√° estiver na aba dashboard)
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se j√° estamos na aba dashboard
      const dashboardTab = document.getElementById('adminDashboard');
      if (dashboardTab && dashboardTab.classList.contains('active')) {
        setTimeout(() => {
          loadDashboardData();
        }, 500);
      }
    });
  </script>
  <script src="script.js"></script>
</body>
</html>
