<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Defensoria P√∫blica MS</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Bot√£o de admin no canto superior direito -->
  <button id="adminBtn" class="admin-btn" onclick="toggleLoginModal()">
    üîê √Årea Administrativa
  </button>

  <div class="container">

    <!-- Barra de busca centralizada -->
    <div class="search-bar">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Pesquise por unidade, √≥rg√£o ou defensor..." 
        onkeyup="searchUnit()" 
      />
    </div>

    <!-- Filtros -->
    <div class="filters">
      <label>
        <input type="radio" name="filter" value="todos" checked onchange="searchUnit()"> Todas Defensorias
      </label>
      <label>
        <input type="radio" name="filter" value="vagos" onchange="searchUnit()"> Defensorias Vagas
      </label>
      <label>
        <input type="radio" name="filter" value="afastados" onchange="searchUnit()"> Titulares Afastados
      </label>
      <label class="filter-chip" id="toggleRegionalChip">
        <input type="checkbox" id="toggleRegionalCheckbox" onchange="toggleRegionalFilters()">
        <span id="toggleRegionalText">Filtrar por Regional</span>
        <span id="toggleRegionalIcon">‚ñº</span>
      </label>
      <button class="collapse-all-btn" id="collapseAllBtn" onclick="toggleAllUnits()">
        <span id="collapseAllIcon">üìÅ</span>
        <span id="collapseAllText">Colapsar Todas</span>
      </button>
    </div>

    <!-- Filtros por Regional -->
    <div class="regional-filters">
      <div class="regional-chips" id="regionalChips" style="display: none;">
        <!-- Chips das regionais ser√£o carregados aqui -->
      </div>
    </div>

    <div id="unitList" class="unit-list">
      <!-- Unidades aparecem aqui -->
    </div>
  </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üîê √Årea Administrativa</h2>
          <span class="close" onclick="closeLoginModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="form-group">
              <label for="username">Usu√°rio:</label>
              <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
              <label for="password">Senha:</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div class="form-actions">
              <button type="button" onclick="closeLoginModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-login">Entrar</button>
            </div>
          </form>
          <div id="loginError" class="error-message" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- √Årea Administrativa -->
    <div id="adminArea" class="admin-area" style="display: none;">
      <div class="admin-header">
        <h2>üîß Painel Administrativo</h2>
        <div class="admin-actions">
          <span id="adminWelcome" class="admin-welcome"></span>
          <button onclick="logout()" class="btn-logout">Sair</button>
        </div>
      </div>

      <div class="admin-tabs">
        <button class="tab-btn active" onclick="showAdminTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="showAdminTab('regionais')">üåç Regionais</button>
        <button class="tab-btn" onclick="showAdminTab('unidades')">üè¢ Unidades</button>
        <button class="tab-btn" onclick="showAdminTab('orgaos')">üë• Defensorias</button>
      </div>

      <!-- Dashboard -->
      <div id="adminDashboard" class="admin-tab-content active">
        <div class="dashboard-stats">
          <div class="stat-card">
            <h3>Total de Unidades</h3>
            <span id="totalUnidades" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Total de Defensorias</h3>
            <span id="totalOrgaos" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Defensorias Vagas</h3>
            <span id="orgaosVagos" class="stat-number">-</span>
          </div>
          <div class="stat-card">
            <h3>Titulares Afastados</h3>
            <span id="titularesAfastados" class="stat-number">-</span>
          </div>
        </div>

              <!-- Gr√°ficos e An√°lises Detalhadas -->
              <div class="dashboard-charts">
                <!-- Gr√°ficos removidos temporariamente -->
              </div>

        <div class="dashboard-tables">
          <div class="table-container">
            <div>
              <h3>üìä Estat√≠sticas por Regional</h3>
              <div class="table-wrapper">
                <table id="regionaisTable">
                  <thead>
                    <tr>
                      <th onclick="sortTable('regionaisTable', 0)" class="sortable">
                        Regional <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 1)" class="sortable">
                        Defensorias <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 2)" class="sortable">
                        Vagas <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 3)" class="sortable">
                        % Vagas <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 4)" class="sortable">
                        Afastados <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 5)" class="sortable">
                        % Afastados <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 6)" class="sortable">
                        Total <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                      <th onclick="sortTable('regionaisTable', 7)" class="sortable">
                        % Total <span class="sort-icon">‚ÜïÔ∏è</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="regionaisTableBody">
                    <!-- Dados ser√£o carregados aqui -->
                  </tbody>
                  <tfoot id="regionaisTableFooter" style="display: none;">
                    <!-- Totais ser√£o carregados aqui -->
                  </tfoot>
                </table>
              </div>
            </div>
            <div class="chart-container-regionais">
              <!-- Bot√µes de sele√ß√£o de estat√≠stica -->
              <div class="chart-selector">
                <button class="chart-btn active" data-stat="total-vagas" onclick="changeChartType('total-vagas')">
                  Vagas
                </button>
                <button class="chart-btn" data-stat="percent-vagas" onclick="changeChartType('percent-vagas')">
                  % Vagas
                </button>
                <button class="chart-btn" data-stat="total-afastados" onclick="changeChartType('total-afastados')">
                  Afastados
                </button>
                <button class="chart-btn" data-stat="percent-afastados" onclick="changeChartType('percent-afastados')">
                  % Afastados
                </button>
                <button class="chart-btn" data-stat="total-prejudicadas" onclick="changeChartType('total-prejudicadas')">
                  Total
                </button>
                <button class="chart-btn" data-stat="percent-prejudicadas" onclick="changeChartType('percent-prejudicadas')">
                  % Total
                </button>
              </div>
              
              <canvas id="regionaisChart"></canvas>
            </div>
          </div>

          <!-- Tabela de Defensorias Vagas -->
          <div class="table-container">
            <h3 class="collapsible-title" onclick="toggleTable('vagasTable')">
              üìã Defensorias Vagas <span class="collapse-icon">‚ñº</span>
            </h3>
            <div class="table-wrapper" id="vagasTable" style="display: none;">
              <table id="vagasTable">
                <thead>
                  <tr>
                    <th onclick="sortTable('vagasTable', 0)" class="sortable">
                      Regional <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th onclick="sortTable('vagasTable', 1)" class="sortable">
                      Unidade <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th class="actions-column">Editar</th>
                    <th onclick="sortTable('vagasTable', 3)" class="sortable">
                      Defensoria <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th onclick="sortTable('vagasTable', 4)" class="sortable">
                      Substituto <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="vagasTableBody">
                  <!-- Dados ser√£o carregados aqui -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tabela de Titulares Afastados -->
          <div class="table-container">
            <h3 class="collapsible-title" onclick="toggleTable('afastadosTable')">
              üìã Titulares Afastados <span class="collapse-icon">‚ñº</span>
            </h3>
            <div class="table-wrapper" id="afastadosTable" style="display: none;">
              <table id="afastadosTable">
                <thead>
                  <tr>
                    <th onclick="sortTable('afastadosTable', 0)" class="sortable">
                      Regional <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th onclick="sortTable('afastadosTable', 1)" class="sortable">
                      Unidade <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th class="actions-column">Editar</th>
                    <th onclick="sortTable('afastadosTable', 3)" class="sortable">
                      Defensoria <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th onclick="sortTable('afastadosTable', 4)" class="sortable">
                      Titular <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                    <th onclick="sortTable('afastadosTable', 5)" class="sortable">
                      Substituto <span class="sort-icon">‚ÜïÔ∏è</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="afastadosTableBody">
                  <!-- Dados ser√£o carregados aqui -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Gest√£o de Unidades -->
      <div id="adminUnidades" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>üè¢ Gest√£o de Unidades</h3>
          <div class="admin-header-actions">
            <div class="search-container">
              <input type="text" id="unidadesSearch" placeholder="Buscar unidades..." class="search-input">
              <span class="search-icon">üîç</span>
            </div>
            <button onclick="openUnidadeModal()" class="btn-add">+ Nova Unidade</button>
          </div>
        </div>
        <div id="unidadesList" class="admin-list">
          <!-- Lista de unidades ser√° carregada aqui -->
        </div>
      </div>

      <!-- Gest√£o de √ìrg√£os -->
      <div id="adminOrgaos" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>üë• Gest√£o de Defensorias</h3>
          <div class="admin-header-actions">
            <div class="search-container">
              <input type="text" id="orgaosSearch" placeholder="Buscar defensorias..." class="search-input">
              <span class="search-icon">üîç</span>
            </div>
            <button onclick="openOrgaoModal()" class="btn-add">+ Nova Defensoria</button>
          </div>
        </div>
        <div id="orgaosList" class="admin-list">
          <!-- Lista de defensorias ser√° carregada aqui -->
        </div>
      </div>

      <!-- Gest√£o de Regionais -->
      <div id="adminRegionais" class="admin-tab-content">
        <div class="admin-section-header">
          <h3>üåç Gest√£o de Regionais</h3>
          <div class="admin-header-actions">
            <div class="search-container">
              <input type="text" id="regionaisSearch" placeholder="Buscar regionais..." class="search-input">
              <span class="search-icon">üîç</span>
            </div>
            <button onclick="openRegionalModal()" class="btn-add">+ Nova Regional</button>
          </div>
        </div>
        <div id="regionaisList" class="admin-list">
          <!-- Lista de regionais ser√° carregada aqui -->
        </div>
      </div>

    </div>

    <!-- Modal de Unidade -->
    <div id="unidadeModal" class="modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2 id="unidadeModalTitle">Nova Unidade</h2>
          <span class="close" onclick="closeUnidadeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="unidadeForm">
            <input type="hidden" id="unidadeId">
            <div class="form-row">
              <div class="form-group">
                <label for="unidadeNome">Nome da Unidade *</label>
                <input type="text" id="unidadeNome" required>
              </div>
              <div class="form-group">
                <label for="unidadeRegional">Regional *</label>
                <select id="unidadeRegional" required>
                  <option value="">Selecione uma regional</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="unidadeEndereco">Endere√ßo *</label>
                <input type="text" id="unidadeEndereco" required>
              </div>
              <div class="form-group">
                <label for="unidadeTelefone">Telefone *</label>
                <input type="text" id="unidadeTelefone" required>
              </div>
            </div>
            
            <div class="form-section">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="unidadeTemCoordenador">
                  <span class="checkmark"></span>
                  Esta unidade possui coordena√ß√£o
                </label>
              </div>
              <div id="coordenadorFields" class="conditional-fields" style="display: none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="unidadeCoordenador">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="unidadeCoordenador">
                  </div>
                  <div class="form-group">
                    <label for="unidadeEmailCoordenador">Email da Coordena√ß√£o *</label>
                    <input type="email" id="unidadeEmailCoordenador">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-section">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="unidadeTemSupervisor">
                  <span class="checkmark"></span>
                  Esta unidade possui supervis√£o
                </label>
              </div>
              <div id="supervisorFields" class="conditional-fields" style="display: none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="unidadeSupervisor">Nome da Supervis√£o *</label>
                    <input type="text" id="unidadeSupervisor">
                  </div>
                  <div class="form-group">
                    <label for="unidadeEmailSupervisor">Email da Supervis√£o *</label>
                    <input type="email" id="unidadeEmailSupervisor">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Coordena√ß√µes de Segunda Inst√¢ncia (apenas para CAMPO GRANDE | 2¬™ INST√ÇNCIA) -->
            <div id="coordenacoesSegundaInstancia" class="form-section" style="display: none;">
              <h4>üéØ Coordena√ß√µes de Segunda Inst√¢ncia</h4>
              
              <div class="coordenacao-group">
                <h5>Coordena√ß√£o Administrativa</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoAdminNome">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="coordenacaoAdminNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoAdminEmail">Email da Coordena√ß√£o</label>
                    <input type="email" id="coordenacaoAdminEmail">
                  </div>
                </div>
              </div>
              
              <div class="coordenacao-group">
                <h5>Coordena√ß√£o C√≠vel</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoCivelNome">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="coordenacaoCivelNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoCivelEmail">Email da Coordena√ß√£o</label>
                    <input type="email" id="coordenacaoCivelEmail">
                  </div>
                </div>
              </div>
              
              <div class="coordenacao-group">
                <h5>Coordena√ß√£o Criminal</h5>
                <div class="form-row">
                  <div class="form-group">
                    <label for="coordenacaoCriminalNome">Nome da Coordena√ß√£o *</label>
                    <input type="text" id="coordenacaoCriminalNome">
                  </div>
                  <div class="form-group">
                    <label for="coordenacaoCriminalEmail">Email da Coordena√ß√£o</label>
                    <input type="email" id="coordenacaoCriminalEmail">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" onclick="closeUnidadeModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de Defensoria -->
    <div id="orgaoModal" class="modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h2 id="orgaoModalTitle">Nova Defensoria</h2>
          <span class="close" onclick="closeOrgaoModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="orgaoForm">
            <input type="hidden" id="orgaoId">
            <div class="form-row">
              <div class="form-group">
                <label for="orgaoNome">Nome da Defensoria *</label>
                <input type="text" id="orgaoNome" required>
              </div>
              <div class="form-group">
                <label for="orgaoUnidade">Unidade *</label>
                <select id="orgaoUnidade" required>
                  <option value="">Selecione uma unidade</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="orgaoVaga">
                <span class="checkmark"></span>
                Defensoria vaga
              </label>
            </div>
            
            <div id="titularFields" class="conditional-fields">
              <div class="form-section">
                <h4>Titular</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orgaoTitularNome">Nome do Titular *</label>
                    <input type="text" id="orgaoTitularNome">
                  </div>
                  <div class="form-group">
                    <label for="orgaoTitularEmail">Email do Titular *</label>
                    <input type="email" id="orgaoTitularEmail">
                  </div>
                </div>
                <div class="form-group">
                  <label class="checkbox-label">
                    <input type="checkbox" id="orgaoTitularAfastado">
                    <span class="checkmark"></span>
                    Titular afastado
                  </label>
                </div>
              </div>
            </div>
            
            <div id="substitutoFields" class="conditional-fields" style="display: none;">
              <div class="form-section">
                <h4>Substituto</h4>
                <div class="form-row">
                  <div class="form-group">
                    <label for="orgaoSubstitutoNome">Nome do Substituto *</label>
                    <input type="text" id="orgaoSubstitutoNome">
                  </div>
                  <div class="form-group">
                    <label for="orgaoSubstitutoEmail">Email do Substituto *</label>
                    <input type="email" id="orgaoSubstitutoEmail">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-actions">
              <button type="button" onclick="closeOrgaoModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal de Regional -->
    <div id="regionalModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="regionalModalTitle">Nova Regional</h2>
          <span class="close" onclick="closeRegionalModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="regionalForm">
            <input type="hidden" id="regionalId">
            <div class="form-row">
              <div class="form-group">
                <label for="regionalNome">Nome da Regional *</label>
                <input type="text" id="regionalNome" required placeholder="Ex: 1¬™ Regional de Campo Grande">
              </div>
              <div class="form-group">
                <label for="regionalNumero">N√∫mero da Regional *</label>
                <input type="number" id="regionalNumero" required min="1" placeholder="Ex: 1">
              </div>
            </div>
            <div class="form-actions">
              <button type="button" onclick="closeRegionalModal()" class="btn-cancel">Cancelar</button>
              <button type="submit" class="btn-save">Salvar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  <script>
    // Dashboard Charts and Data Loading
    let dashboardData = {};

    // Load dashboard data when admin dashboard is shown
    async function loadDashboardData() {
      console.log('üîÑ Carregando dados do dashboard...');
      try {
        // Load statistics
        console.log('üìä Carregando estat√≠sticas...');
        const statsResponse = await fetch('/api/dashboard/stats');
        dashboardData.stats = await statsResponse.json();
        console.log('‚úÖ Estat√≠sticas carregadas:', dashboardData.stats);
        updateStatsDisplay();

        // Load regional data
        console.log('üè¢ Carregando dados regionais...');
        const regionaisResponse = await fetch('/api/dashboard/regionais');
        dashboardData.regionais = await regionaisResponse.json();
        console.log('‚úÖ Dados regionais carregados:', dashboardData.regionais.length, 'regionais');
        renderRegionaisTable();

        // Load problems data
        console.log('‚ö†Ô∏è Carregando dados dos problemas...');
        const problemasResponse = await fetch('/api/dashboard/problemas');
        dashboardData.problemas = await problemasResponse.json();
        console.log('‚úÖ Dados dos problemas carregados:', dashboardData.problemas.length, 'problemas');
        renderProblemasTable();

        console.log('üéâ Dashboard carregado com sucesso!');

      } catch (error) {
        console.error('‚ùå Erro ao carregar dados do dashboard:', error);
        showError('Erro ao carregar dados do dashboard');
      }
    }

    function updateStatsDisplay() {
      if (dashboardData.stats) {
        document.getElementById('totalUnidades').textContent = dashboardData.stats.total_unidades;
        document.getElementById('totalOrgaos').textContent = dashboardData.stats.total_defensorias;
        document.getElementById('orgaosVagos').textContent = dashboardData.stats.defensorias_vagas;
        document.getElementById('titularesAfastados').textContent = dashboardData.stats.titulares_afastados;
      }
    }


    // Vari√°vel global para armazenar dados do gr√°fico
    let chartData = {
      labels: [],
      percentVagas: [],
      totalVagas: [],
      percentAfastados: [],
      totalAfastados: [],
      totalPrejudicadas: [],
      percentPrejudicadas: [],
      colors: {
        percentVagas: [],
        totalVagas: [],
        percentAfastados: [],
        totalAfastados: [],
        totalPrejudicadas: [],
        percentPrejudicadas: []
      }
    };

    function renderRegionaisTable() {
      if (!dashboardData.regionais) return;

      const tbody = document.getElementById('regionaisTableBody');
      tbody.innerHTML = '';

      // Limpar dados anteriores
      chartData = {
        labels: [],
        percentVagas: [],
        totalVagas: [],
        percentAfastados: [],
        totalAfastados: [],
        totalPrejudicadas: [],
        percentPrejudicadas: [],
        colors: {
          percentVagas: [],
          totalVagas: [],
          percentAfastados: [],
          totalAfastados: [],
          totalPrejudicadas: [],
          percentPrejudicadas: []
        }
      };

      dashboardData.regionais.forEach(regional => {
        const row = document.createElement('tr');
        
        // Calcular percentuais
        const totalDefensorias = parseInt(regional.total_defensorias) || 0;
        const defensoriasVagas = parseInt(regional.defensorias_vagas) || 0;
        const titularesAfastados = parseInt(regional.titulares_afastados) || 0;
        
        const percentVagas = totalDefensorias > 0 ? 
          ((defensoriasVagas / totalDefensorias) * 100).toFixed(1) : '0.0';
        const percentAfastados = totalDefensorias > 0 ? 
          ((titularesAfastados / totalDefensorias) * 100).toFixed(1) : '0.0';
        
        // Calcular total de defensorias prejudicadas (vagas + afastados)
        const totalPrejudicadas = defensoriasVagas + titularesAfastados;
        const percentTotal = totalDefensorias > 0 ? 
          ((totalPrejudicadas / totalDefensorias) * 100).toFixed(1) : '0.0';
        
        // Classes para destacar percentuais altos
        const vagasClass = parseFloat(percentVagas) > 20 ? 'percent-alto' : 
                          parseFloat(percentVagas) > 10 ? 'percent-medio' : 'percent-baixo';
        const afastadosClass = parseFloat(percentAfastados) > 20 ? 'percent-alto' : 
                              parseFloat(percentAfastados) > 10 ? 'percent-medio' : 'percent-baixo';
        const totalClass = parseFloat(percentTotal) > 20 ? 'percent-alto' : 
                          parseFloat(percentTotal) > 10 ? 'percent-medio' : 'percent-baixo';
        
        row.innerHTML = `
          <td>${regional.nome}</td>
          <td>${totalDefensorias}</td>
          <td>${defensoriasVagas}</td>
          <td><span class="percent-problemas ${vagasClass}">${percentVagas}%</span></td>
          <td>${titularesAfastados}</td>
          <td><span class="percent-problemas ${afastadosClass}">${percentAfastados}%</span></td>
          <td>${totalPrejudicadas}</td>
          <td><span class="percent-problemas ${totalClass}">${percentTotal}%</span></td>
        `;
        tbody.appendChild(row);

        // Preparar dados para o gr√°fico
        chartData.labels.push(regional.nome);
        chartData.percentVagas.push(parseFloat(percentVagas));
        chartData.totalVagas.push(defensoriasVagas);
        chartData.percentAfastados.push(parseFloat(percentAfastados));
        chartData.totalAfastados.push(titularesAfastados);
        chartData.totalPrejudicadas.push(totalPrejudicadas);
        chartData.percentPrejudicadas.push(parseFloat(percentTotal));
        
        // Definir cores baseadas nos valores
        chartData.colors.percentVagas.push(getColorByValue(parseFloat(percentVagas), 'percent'));
        chartData.colors.totalVagas.push(getColorByValue(defensoriasVagas, 'total'));
        chartData.colors.percentAfastados.push(getColorByValue(parseFloat(percentAfastados), 'percent'));
        chartData.colors.totalAfastados.push(getColorByValue(titularesAfastados, 'total'));
        chartData.colors.totalPrejudicadas.push(getColorByValue(totalPrejudicadas, 'total'));
        chartData.colors.percentPrejudicadas.push(getColorByValue(parseFloat(percentTotal), 'percent'));
      });

      // Criar o gr√°fico inicial (total de vagas)
      createRegionaisChart('total-vagas');
      
      // Calcular e exibir totais no rodap√©
      renderRegionaisFooter();
    }

    // Fun√ß√£o para renderizar o rodap√© com totais
    function renderRegionaisFooter() {
      if (!dashboardData.regionais || dashboardData.regionais.length === 0) return;

      const tfoot = document.getElementById('regionaisTableFooter');
      if (!tfoot) return;

      // Calcular totais
      let totalDefensorias = 0;
      let totalVagas = 0;
      let totalAfastados = 0;
      let totalPrejudicadas = 0;

      dashboardData.regionais.forEach(regional => {
        totalDefensorias += parseInt(regional.total_defensorias) || 0;
        totalVagas += parseInt(regional.defensorias_vagas) || 0;
        totalAfastados += parseInt(regional.titulares_afastados) || 0;
      });

      totalPrejudicadas = totalVagas + totalAfastados;

      // Calcular percentuais
      const percentVagas = totalDefensorias > 0 ? 
        ((totalVagas / totalDefensorias) * 100).toFixed(1) : '0.0';
      const percentAfastados = totalDefensorias > 0 ? 
        ((totalAfastados / totalDefensorias) * 100).toFixed(1) : '0.0';
      const percentTotal = totalDefensorias > 0 ? 
        ((totalPrejudicadas / totalDefensorias) * 100).toFixed(1) : '0.0';

      // Classes para destacar percentuais altos
      const vagasClass = parseFloat(percentVagas) > 20 ? 'percent-alto' : 
                        parseFloat(percentVagas) > 10 ? 'percent-medio' : 'percent-baixo';
      const afastadosClass = parseFloat(percentAfastados) > 20 ? 'percent-alto' : 
                            parseFloat(percentAfastados) > 10 ? 'percent-medio' : 'percent-baixo';
      const totalClass = parseFloat(percentTotal) > 20 ? 'percent-alto' : 
                        parseFloat(percentTotal) > 10 ? 'percent-medio' : 'percent-baixo';

      // Renderizar rodap√©
      tfoot.innerHTML = `
        <tr>
          <td>TOTAL GERAL</td>
          <td>${totalDefensorias}</td>
          <td>${totalVagas}</td>
          <td><span class="percent-problemas ${vagasClass}">${percentVagas}%</span></td>
          <td>${totalAfastados}</td>
          <td><span class="percent-problemas ${afastadosClass}">${percentAfastados}%</span></td>
          <td>${totalPrejudicadas}</td>
          <td><span class="percent-problemas ${totalClass}">${percentTotal}%</span></td>
        </tr>
      `;

      // Mostrar o rodap√©
      tfoot.style.display = 'table-footer-group';
    }

    // Fun√ß√£o para determinar cor baseada no valor
    function getColorByValue(value, type) {
      if (type === 'percent') {
        if (value > 20) return '#dc3545'; // Vermelho para alto
        if (value > 10) return '#ffc107'; // Amarelo para m√©dio
        return '#28a745'; // Verde para baixo
      } else {
        // Para valores absolutos, usar uma escala baseada no m√°ximo
        let maxValue;
        if (type === 'total') {
          // Usar o maior valor entre totalVagas, totalAfastados e totalPrejudicadas
          maxValue = Math.max(
            Math.max(...chartData.totalVagas),
            Math.max(...chartData.totalAfastados),
            Math.max(...chartData.totalPrejudicadas)
          );
        } else {
          maxValue = Math.max(...chartData[type === 'total' ? 'totalVagas' : 'totalAfastados']);
        }
        const ratio = value / maxValue;
        if (ratio > 0.7) return '#dc3545';
        if (ratio > 0.4) return '#ffc107';
        return '#28a745';
      }
    }

    function createRegionaisChart(statType) {
      const ctx = document.getElementById('regionaisChart');
      if (!ctx || !chartData.labels.length) return;

      // Destruir gr√°fico existente se houver
      if (window.regionaisChartInstance) {
        window.regionaisChartInstance.destroy();
      }

      // Determinar dados e configura√ß√µes baseado no tipo
      let data, colors, label, yAxisLabel, tooltipSuffix;
      
      switch(statType) {
        case 'percent-vagas':
          data = chartData.percentVagas;
          colors = chartData.colors.percentVagas;
          label = '% Vagas';
          yAxisLabel = '%';
          tooltipSuffix = '%';
          break;
        case 'total-vagas':
          data = chartData.totalVagas;
          colors = chartData.colors.totalVagas;
          label = 'Vagas';
          yAxisLabel = 'Quantidade';
          tooltipSuffix = ' vagas';
          break;
        case 'percent-afastados':
          data = chartData.percentAfastados;
          colors = chartData.colors.percentAfastados;
          label = '% Afastados';
          yAxisLabel = '%';
          tooltipSuffix = '%';
          break;
        case 'total-afastados':
          data = chartData.totalAfastados;
          colors = chartData.colors.totalAfastados;
          label = 'Afastados';
          yAxisLabel = 'Quantidade';
          tooltipSuffix = ' afastados';
          break;
        case 'total-prejudicadas':
          data = chartData.totalPrejudicadas;
          colors = chartData.colors.totalPrejudicadas;
          label = 'Total';
          yAxisLabel = 'Quantidade';
          tooltipSuffix = ' prejudicadas';
          break;
        case 'percent-prejudicadas':
          data = chartData.percentPrejudicadas;
          colors = chartData.colors.percentPrejudicadas;
          label = '% Total';
          yAxisLabel = '%';
          tooltipSuffix = '%';
          break;
        default:
          return;
      }

      window.regionaisChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: colors,
            borderColor: colors.map(color => color),
            borderWidth: 1,
            borderRadius: 4,
            borderSkipped: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  return value.toFixed(statType.includes('percent') ? 1 : 0) + tooltipSuffix;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: statType.includes('percent') ? Math.max(...data) + 5 : Math.max(...data) + 1,
              ticks: {
                callback: function(value) {
                  return value + (statType.includes('percent') ? '%' : '');
                }
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                font: {
                  size: 10
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Fun√ß√£o para trocar o tipo de gr√°fico
    function changeChartType(statType) {
      // Atualizar bot√µes ativos
      document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-stat="${statType}"]`).classList.add('active');
      
      // Atualizar gr√°fico
      createRegionaisChart(statType);
    }

    function renderProblemasTable() {
      if (!dashboardData.problemas) return;

      // Separar os dados em defensorias vagas e titulares afastados
      const defensoriasVagas = dashboardData.problemas.filter(problema => problema.vaga === true);
      const titularesAfastados = dashboardData.problemas.filter(problema => problema.titular_afastado === true);

      // Renderizar tabela de defensorias vagas
      renderVagasTable(defensoriasVagas);
      
      // Renderizar tabela de titulares afastados
      renderAfastadosTable(titularesAfastados);
    }

    function renderVagasTable(defensoriasVagas) {
      const tbody = document.getElementById('vagasTableBody');
      tbody.innerHTML = '';

      defensoriasVagas.forEach(defensoria => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${defensoria.regional_nome || '-'}</td>
          <td>${defensoria.unidade_nome}</td>
          <td class="actions-column">
            <button class="btn-edit-small" onclick="editDefensoriaFromTable(${defensoria.id})" title="Editar Defensoria">
              ‚úèÔ∏è
            </button>
          </td>
          <td>${defensoria.nome}</td>
          <td>${defensoria.substituto_nome || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderAfastadosTable(titularesAfastados) {
      const tbody = document.getElementById('afastadosTableBody');
      tbody.innerHTML = '';

      titularesAfastados.forEach(defensoria => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${defensoria.regional_nome || '-'}</td>
          <td>${defensoria.unidade_nome}</td>
          <td class="actions-column">
            <button class="btn-edit-small" onclick="editDefensoriaFromTable(${defensoria.id})" title="Editar Defensoria">
              ‚úèÔ∏è
            </button>
          </td>
          <td>${defensoria.nome}</td>
          <td>${defensoria.titular_nome || '-'}</td>
          <td>${defensoria.substituto_nome || '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function showError(message) {
      console.error(message);
      // You can add a toast notification here if needed
    }

    // Override the original showAdminTab function to load dashboard data
    const originalShowAdminTab = window.showAdminTab;
    window.showAdminTab = function(tabName) {
      originalShowAdminTab(tabName);
      if (tabName === 'dashboard') {
        // Aguardar um pouco para garantir que o DOM est√° pronto
        setTimeout(() => {
          loadDashboardData();
        }, 100);
      }
    };

    // Carregar dados do dashboard quando a p√°gina carregar (se j√° estiver na aba dashboard)
    document.addEventListener('DOMContentLoaded', function() {
      // Verificar se j√° estamos na aba dashboard
      const dashboardTab = document.getElementById('adminDashboard');
      if (dashboardTab && dashboardTab.classList.contains('active')) {
        setTimeout(() => {
          loadDashboardData();
        }, 500);
      }
    });

    // Fun√ß√£o para ordenar tabelas
    function sortTable(tableId, columnIndex) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const headers = table.querySelectorAll('th');
      
      // Determinar dire√ß√£o da ordena√ß√£o
      const currentHeader = headers[columnIndex];
      const currentSort = currentHeader.getAttribute('data-sort');
      const newSort = currentSort === 'asc' ? 'desc' : 'asc';
      
      // Limpar indicadores de ordena√ß√£o de todas as colunas
      headers.forEach(header => {
        header.removeAttribute('data-sort');
        const icon = header.querySelector('.sort-icon');
        if (icon) {
          icon.classList.remove('sorted-asc', 'sorted-desc');
        }
      });
      
      // Definir nova ordena√ß√£o
      currentHeader.setAttribute('data-sort', newSort);
      const icon = currentHeader.querySelector('.sort-icon');
      if (icon) {
        icon.classList.add(newSort === 'asc' ? 'sorted-asc' : 'sorted-desc');
      }
      
      // Ordenar linhas
      rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        // Verificar se √© num√©rico (incluindo percentuais)
        const aNum = parseFloat(aValue.replace('%', ''));
        const bNum = parseFloat(bValue.replace('%', ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          // Ordena√ß√£o num√©rica
          return newSort === 'asc' ? aNum - bNum : bNum - aNum;
        } else {
          // Ordena√ß√£o alfab√©tica com suporte a n√∫meros
          return newSort === 'asc' 
            ? aValue.localeCompare(bValue, 'pt-BR', { numeric: true })
            : bValue.localeCompare(aValue, 'pt-BR', { numeric: true });
        }
      });
      
      // Reordenar linhas na tabela
      rows.forEach(row => tbody.appendChild(row));
    }
  </script>
  <script src="script.js?v=1.1"></script>
</body>
</html>
